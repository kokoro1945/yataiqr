# 屋台QRコード生成ツール 仕様書

## 背景と目的
- 学園祭などのイベントで使用する屋台アンケートフォームへの導線を簡易化する。
- ブラウザ上で屋台番号を入力するだけでフォーム直リンクとQRコードを生成し、印刷や共有に活用できるようにする。

## 用語定義
- **屋台番号**: 屋台ごとに割り当てられた識別子。数値（例: 12）または英字＋数値（例: A01）形式を想定。
- **フォームURL**: `https://kokoro1945.github.io/yatairanking2025/` に `?booth={屋台番号}` クエリを付与したアクセス用リンク。

## 想定ユーザーと利用シナリオ
1. 事前準備担当者がPCでページを開く。
2. 屋台番号を入力し「QR生成」を押す。
3. 表示されたQRコードを印刷または画像として保存し、フォームURLをコピーして共有する。
4. 同ページを再利用し別の屋台番号のQRを連続で発行する。

## 機能要件
- **屋台番号入力**
  - 入力フィールド `#booth` に任意の文字列を受け付ける。
  - 正規化処理で半角英数字以外を除去し、大文字化する。
  - 先頭が英字の場合は英字1文字＋数字2桁（ゼロ埋め）形式に整形する。
  - 数字のみの場合はゼロ埋め設定に応じて 3 桁ゼロ埋めまたは自然数表記に変換する。
  - 0 以下や数字が存在しない入力は無効扱いとする。

- **ゼロ埋め設定**
  - チェックボックス `#pad` が ON の間、数値のみの屋台番号を 3 桁ゼロ埋めする。
  - OFF の場合はゼロ埋めせず自然数表記にする。

- **QR サイズ選択**
  - セレクトボックス `#qrsize` で 240 / 300 / 360 / 420 / 600 px から選択。
  - 未選択または不正値の場合は 300px を既定値とする。

- **ラベル入力**
  - テキストフィールド `#label` に自由入力。
  - 屋台番号入力やゼロ埋め設定変更時に「屋台No. {屋台番号}（任意で屋台名）」を自動反映し、手動で変更済みの場合は保持する。
  - QR再生成後でも、ラベル入力値の変更は即座にプレビューへ反映する。

- **QR 生成ボタン**
  - `#gen` クリックまたは `#booth` で Enter キー押下で QR 生成を実行。
  - 生成中は「QRを生成しています…」プレースホルダー表示とともにダウンロード／コピー機能を無効化する。

- **フォームURL 表示**
  - `#formurl` に生成したフォームURLを表示。無効入力時は「（屋台番号を入力してください）」を表示。

- **ダウンロードリンク**
  - 生成成功時 `#download` に data URL と推奨ファイル名 `Yatai_{屋台番号}_QR_{サイズ}.png` を設定。
  - 無効化状態では `href` を取り除き、ボタンに `disabled` クラスを付与する。

- **URLコピー**
  - `#copy` クリックで `navigator.clipboard.writeText` によりフォームURLをコピー。
  - 成功時 1.4 秒間「コピー済み！」を表示。失敗時はアラートで手動コピーを案内。

- **ページURLとの同期**
  - 屋台番号確定時、現在ページのクエリ `?booth=...` を上書きし、`document.title` を「屋台QR: {屋台番号}」へ更新。
  - ページ初期化時にクエリ `booth` が存在すれば入力欄・ラベルに反映し、自動でQR生成を行う。

- **プレースホルダー表示**
  - 初期状態および無効入力時は QR 領域に「ここにQRが表示されます」を表示。
  - エラー発生時は「QR生成に失敗しました」を表示。

- **連続レンダリング防止**
  - 非同期生成中に再度生成要求が来た場合はトークンで最新リクエストだけを採用する。

## 非機能要件
- ブラウザのみで動作し、バックエンド不要。
- 外部ライブラリとして `qrcode`（ブラウザビルド）を利用し、PNG形式のデータURLを生成する。
- 主要モダンブラウザ（Chromium / Firefox / Safari 最新版）での動作を想定。
- クリップボードAPIが利用できない環境ではアラートで代替案を提示する。

## UI/UX 仕様
- フォーム要素は Tailwind CSS をビルドしたスタイルシート `assets/styles.css` を適用する。
- QRボックス `#qrbox` は生成結果を中央揃えで表示し、下部に太字ラベルを付与する。
- 説明文・使い方メモを含むレイアウトは `index.html` のマークアップに準拠する。

## エラー・例外処理
- `pad3` の結果が空の場合は生成処理を中断し、コピー・ダウンロードを無効化する。
- `qrcode` ライブラリで例外が発生した場合はコンソールに出力し、プレースホルダーとボタン無効化状態に戻す。
- クリップボードAPIが拒否された際はエラーをコンソールに記録し、アラートでユーザーへ通知する。

## 今後の拡張余地（参考）
- 複数屋台のQRをまとめて生成する一括モード。
- 生成履歴の保持やPDFエクスポート機能。
- ゼロ埋めルールの個別設定（例: 英字付き番号の桁数変更）。
