# 一括QR生成 管理者ボタン仕様書

## 1. 概要
- 目的: 既存の屋台QR生成ツールに、運営メンバーだけが利用できる管理者ボタンを追加し、定義済みすべての屋台のQRコードを一括生成して ZIP ファイルとしてダウンロードできるようにする。
- ゴール: 手作業による個別生成・ダウンロードを不要にし、イベント準備を効率化する。
- 非ゴール: クラウドストレージへの自動アップロード、閲覧ユーザー向けの一般公開UI、生成後の自動印刷や通知配信。

## 2. 用語・前提
- **管理者ボタン**: ページ上部の操作パネルに常設する「一括QR生成」ボタン。運営メンバー向けに視認性を高めた配置とスタイルにする。
- **カタログデータ**: 一括生成対象となる屋台番号・屋台名のマスタ。`A01`〜`L15` の範囲（詳細は §4）。
- **ZIPアーカイブ**: 生成した PNG 形式のQRコード画像をまとめて格納する圧縮ファイル。ファイル名は処理日時と件数を含む。
- **JSZip**: ブラウザで ZIP を生成するために利用するフロントエンドライブラリ。CDN 経由で読み込む。

## 3. 利用シナリオ
1. ユーザーがページ上部の操作パネルにある「一括QR生成」ボタンを押下。
2. モーダルが開き、対象件数・ZIP出力に関する注意事項が表示される。
3. ユーザーが「生成開始」ボタンを押下すると、非同期で全件生成プロセスが実行される。
4. 状況に応じてプログレスバーと件名リストが更新され、完了時に ZIP ダウンロードボタンが表示される。
5. エラーが発生した場合、モーダル上に件名・原因・再実行ボタンが提示される。必要に応じて再実行して完全なZIPを取得する。

## 4. 対象屋台カタログ
- 屋台番号はすべて英字1文字＋数字2桁形式でゼロ埋めする。
- 屋台名は `booths.csv` から抽出し、番号のゼロ埋め整形後に紐づける。漏れや更新があった場合はカタログファイルを再生成する。
- 対象リスト:
  - `A01`〜`A10`
  - `B01`〜`B10`
  - `C01`〜`C10`
  - `D01`〜`D10`
  - `E01`〜`E13`
  - `F01`〜`F12`
  - `G01`〜`G06`
  - `H01`〜`H05`
  - `I01`〜`I09`
  - `J01`〜`J05`
  - `K01`〜`K12`
  - `L01`〜`L15`

## 5. 機能要件
- **管理者ボタン起動**
  - ページ上部の操作パネルにある「一括QR生成」ボタンを押下するとモーダルを表示。
  - ボタンは視認性を重視した色とサイズで配置し、「運営専用」であることを補足表示する。
- **モーダルUI**
  - 件数、ZIP出力形式、ブラウザ生成である旨の注意を記載。
  - `生成開始` / `キャンセル` / `再実行` / `閉じる` ボタンに加え、処理完了後に `ZIPをダウンロード` リンクを表示。
- **生成キュー**
  - カタログ順に QR 生成を逐次実行する（並列数 1）。
  - 生成サイズは通常選択値（既定 300px）を使用。ラベルは `屋台No. {番号}：{屋台名}` 形式。
  - 生成済みの data URL を base64 抽出して JSZip に追加し、ファイル名を `Yatai_{番号}_{屋台名（半角英数化）}.png` とする。
- **ZIP生成・ダウンロード**
  - 全件処理後に ZIP を生成し、日時＋件数を含むファイル名でダウンロードリンクを提示する。
  - 処理途中で中断しても成功分があれば部分的な ZIP をダウンロード可能。
- **進捗表示**
  - モーダルに完了件数/総件数、進捗バー、最新ステータス（処理中/成功/失敗）を表示。
  - 成功した屋台は「ZIPへ追加済み」と表示し、失敗した屋台には再実行を促すメッセージを付与。
- **エラーハンドリング**
  - QR 生成失敗時は当該屋台を `失敗` 表示にして処理継続。再実行時は全件を対象に再生成する。
  - JSZip の生成失敗時は警告を表示し、再実行またはページ更新を促す。
- **終了処理**
  - 全件成功時は完了メッセージと ZIP ダウンロードリンクを提示し、`閉じる` ボタンを有効化。
  - モーダルを閉じてもバックグラウンド処理は継続しない（すべて完了済み）。

## 6. 非機能要件
- **性能**: 150 件程度の連続生成で 60 秒以内を目標。ZIP 生成も含めてブラウザ上で完結させる。
- **可用性**: 処理中にページを離れると失敗する可能性があるため、モーダル内で注意を促す。失敗時は再実行で復旧可能。
- **セキュリティ**: すべてフロントエンドで完結し、外部送信は行わない。生成したZIPは利用者のPCにのみ保存される。
- **監査**: ブラウザコンソールに開始・完了・失敗をログ出力し、必要に応じてスクリーンショット等で記録する。
- **保守性**: カタログ更新は `scripts/build-booth-catalog.js` などのユーティリティで行い、ソース管理する。
## 7. ZIP アーカイブ仕様
- ファイル名: `Yatai_QR_Batch_yyyymmdd_HHMM_{件数}件.zip`。
- 内容物: 各屋台の PNG 画像（高エラー訂正・300px）を `Yatai_{屋台番号}_{屋台名（半角英数化）}.png` で保存。
- 文字コード: UTF-8。Windows 環境での解凍互換性確保のため、ファイル名は半角英数字と `_` のみ。
- ZIP 生成ライブラリ: JSZip 3.x。ブラウザメモリ上で生成し、完了後に Blob URL でダウンロード。

## 8. テレメトリ・ログ
- フロント: `console.info` で開始・完了・中断、`console.error` で失敗の詳細を記録する。
- 利用者はダウンロード後に Blob URL を解放するため、ボタン押下時にページを閉じないよう警告する。

## 9. 標準テストケース
- 正常系: 全件成功し、ZIP を展開すると 117 件の PNG が含まれている。
- 部分失敗: 任意の屋台で QR 生成エラー → モーダルで失敗表示＋再実行で成功する。
- 中断: 途中で `キャンセル` → 成功分のみ ZIP ダウンロードでき、中断メッセージが表示される。
- UI: 管理者ボタン押下でモーダル表示、完了後にダウンロードリンクが表示される。

## 10. 今後の拡張案
- ZIP 内に README（屋台一覧）を同梱する。
- 生成した ZIP を Google Drive 等へアップロードする追加オプションを用意。
- 屋台番号の任意選択・スキップ機能をモーダルに実装。
