# 一括QR生成隠しコマンド 仕様書

## 1. 概要
- 目的: 既存の屋台QR生成ツールに、運営メンバーだけが利用できる「隠しコマンド」を追加し、定義済みすべての屋台のQRコードを一括生成して Google ドライブ内の指定フォルダへ自動保存する。
- ゴール: 手作業による個別生成・ダウンロードを不要にし、イベント準備を効率化する。
- 非ゴール: ドライブ以外のクラウドストレージ連携、閲覧ユーザー向けの一般公開UI、生成後の自動印刷や通知配信。

## 2. 用語・前提
- **隠しコマンド**: 特定のキーコンビネーションで発火する内部機能（例: Windows/Linux は `Shift + Alt + B`、Mac は `Shift + Option + B` または `Shift + Command + B`）。一般利用者に露出しない。
- **カタログデータ**: 一括生成対象となる屋台番号・屋台名のマスタ。`A01`〜`L15` の範囲（詳細は §4）。
- **Drive フォルダ ID**: Google ドライブの保存先フォルダを特定する 33 文字程度のID。環境変数または設定ファイルで管理し、フロント実装には直接埋め込まない。
- **Drive フォルダ（本番想定）**: `https://drive.google.com/drive/folders/137A0zndjCD6DjrRT8K97IgI6XFgpv0hq?usp=drive_link`
- **サービスアカウント**: Drive API にアクセスするための認証主体。バックエンドで保持し、クライアントには公開しない。

## 3. 利用シナリオ
1. ユーザーが通常画面で `Shift + Alt + B` を押下。
2. 画面右下に「一括QR生成」モーダルが開き、対象件数・保存先フォルダ名・注意事項が表示される。
3. ユーザーが「生成開始」ボタンを押下すると、非同期で全件生成プロセスが実行される。
4. 状況に応じてプログレスバーと件名リストが更新され、完了時に Drive の保存場所を示す確認リンクが表示される。
5. エラーが発生した場合、モーダル上に件名・原因・再実行ボタンが提示される。

## 4. 対象屋台カタログ
- 屋台番号はすべて英字1文字＋数字2桁形式でゼロ埋めする。
- 屋台名は `booths.csv` から抽出し、番号のゼロ埋め整形後に紐づける。漏れや更新があった場合はカタログファイルを再生成する。
- 対象リスト:
  - `A01`〜`A10`
  - `B01`〜`B10`
  - `C01`〜`C10`
  - `D01`〜`D10`
  - `E01`〜`E13`
  - `F01`〜`F12`
  - `G01`〜`G06`
  - `H01`〜`H05`
  - `I01`〜`I09`
  - `J01`〜`J05`
  - `K01`〜`K12`
  - `L01`〜`L15`

## 5. 機能要件
- **隠しコマンド検知**
  - `Shift + Alt + B` を 600ms 以内に検出した場合のみモーダルを表示。
  - 既にモーダル表示中はリトリガーされない。
- **モーダルUI**
  - 件数、保存先フォルダ名、Drive アカウント情報、実行時の注意を記載。
  - `生成開始` / `キャンセル` ボタンを配置。キャンセル時は後続処理を開始しない。
- **生成キュー**
  - カタログ順に QR 生成を行う。並列数は 3 件を上限とする。
  - 生成サイズは通常選択値（既定 300px）を使用。ラベルは `屋台No. {番号}：{屋台名}` 形式。
  - 生成済みの data URL を `Blob` に変換し、ファイル名を `Yatai_{番号}_{屋台名（半角英数化）}.png` とする。
- **Drive アップロード**
  - バックエンド API (`POST /api/batch-upload`) に JSON で `boothId`, `boothName`, `fileName`, `imageData(base64)` を送信。
  - API は Drive フォルダ ID を元に PNG ファイルを作成し、`appProperties` へ `boothId` と `boothName` を格納する。
  - アップロード成功時に `fileId` と `webViewLink` を返却する。
- **進捗表示**
  - モーダルに完了件数/総件数、進捗バー、最新ステータス（処理中/成功/失敗）を表示。
  - 成功した屋台はチェックアイコン＋ Drive リンクを表示し、失敗した屋台はリトライボタンを付与。
- **エラーハンドリング**
  - QR 生成失敗時は当該屋台を `失敗` 表示にして処理継続。
  - API から 401/403/500 系エラーを受けた場合は全体を停止し、「認証エラー」または「Upload エラー」として表示。
  - 失敗件数 > 0 の場合、モーダルのフッターに「失敗した屋台のみ再実行」ボタンを表示。
- **終了処理**
  - 全件成功時は完了メッセージとフォルダの `webViewLink` を提示し、`閉じる` ボタンを有効化。
  - モーダルを閉じてもバックグラウンド処理は継続しない（すべて完了済み）。

## 6. 非機能要件
- **性能**: 150 件程度の連続生成で 60 秒以内を目標。Drive API 呼び出しはレート制限（約 10 req/s）内に収める。
- **可用性**: API 認証エラー時に運営者へ通知できるログをサーバー側で持つ。
- **セキュリティ**: Drive 認証情報はバックエンドのみ保持。フロントにはフォルダID・サービスアカウントの鍵を露出しない。
- **監査**: 生成ログ（屋台番号、生成日時、結果ステータス、ファイルID）をバックエンドで JSONL として保存。
- **保守性**: カタログ更新は `scripts/buildBoothCatalog.ts` などのユーティリティで行い、ソース管理する。

## 7. API 仕様
- `POST /api/batch-upload`
  - 認証: サービスアカウント署名トークン（`Authorization: Bearer <JWT>`）。トークンはバックエンド発行の短期JWT。
  - リクエスト: `{"items":[{ "boothId": "A01", "boothName": "GGクロッフル", "fileName": "Yatai_A01_GGクロッフル.png", "imageData": "data:image/png;base64,..." }]}` 最大 5 件/リクエスト。
  - レスポンス: `{"results":[{ "boothId": "A01", "status": "success", "fileId": "...", "webViewLink": "..." }]}`。
  - エラーレスポンス: HTTP ステータス＋`{"error":{"code":"UPLOAD_FAILED","message":"..."}}`。

## 8. テレメトリ・ログ
- フロント: `console.info` で開始・完了・エラーを記録（開発者向け）。
- バックエンド: Cloud Logging 等にリクエストのサマリ・失敗スタックトレースを出力。
- 重大エラー時は Slack Webhook などでアラート送信（任意）。

## 9. 標準テストケース
- 正常系: 全件成功、Drive に正しいファイル名で保存される。
- 部分失敗: 任意の屋台で Drive API エラー → モーダルで失敗表示＋リトライ成功。
- 認証失敗: トークン期限切れ → 全体停止＋エラーメッセージ。
- キャンセル: モーダルで `キャンセル` → 一切アップロードされない。
- UI: 隠しコマンド押下でモーダル表示、通常操作では表示されない。

## 10. 今後の拡張案
- 生成後に ZIP を自動作成し、ローカルダウンロードオプションを提供。
- Drive 内のサブフォルダを自動生成して年度ごとに整理。
- モーダルから屋台カタログを動的編集できる管理者向け UI を追加。
